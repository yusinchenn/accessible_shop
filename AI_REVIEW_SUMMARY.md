# AI 評論摘要功能說明

## 功能概述

在商品詳情頁面新增了 AI 智能整理評論功能，使用 DeepSeek 模型自動分析和摘要商品評論，幫助視障使用者快速了解商品的整體評價。

## 功能特色

### 🤖 智能觸發條件
- **自動判斷**：當商品具有超過 10 則含文字內容的評論時，頁面自動顯示「AI 整理評論」按鈕
- **API 檢查**：需要正確配置 DeepSeek API Key，否則按鈕不會顯示

### 📊 AI 分析內容
AI 會分析所有評論並提供以下摘要：
1. **主要優點**：客戶最滿意的地方
2. **主要缺點**：需要改進的地方（如果有）
3. **整體評價趨勢**：綜合評價傾向

### 🎯 顯示位置
- AI 摘要卡片顯示在**所有評論的第一則**位置
- 使用紫色漸層背景，易於識別
- 包含 AI 圖標和標題

### 🔊 語音朗讀
- **自動朗讀**：生成摘要後自動朗讀「AI 評論摘要：[摘要內容]」
- **手動朗讀**：單擊 AI 摘要卡片可重新朗讀
- **按鈕提示**：單擊「AI 整理評論」按鈕會播報「正在生成 AI 評論摘要，請稍候」

## 使用流程

### 1. 進入商品詳情頁
```
商品詳情頁 → 滾動到評論區域
```

### 2. 查看是否顯示 AI 按鈕
**條件檢查**：
- ✅ 有 10 則以上含文字的評論
- ✅ DeepSeek API Key 已配置
- ✅ 尚未生成 AI 摘要

**如果符合條件**：會顯示紫色的「AI 整理評論」按鈕

### 3. 點擊生成 AI 摘要
**操作方式**：
- 單擊按鈕：播報「AI 整理評論」
- 雙擊按鈕：開始生成摘要

**生成過程**：
- 按鈕顯示載入動畫
- 播報「正在生成 AI 評論摘要，請稍候」
- 等待 3-10 秒（視評論數量而定）

### 4. 查看和朗讀摘要
**摘要生成後**：
- AI 摘要卡片自動出現在第一則評論位置
- 自動朗讀：「AI 評論摘要：[摘要內容]」
- 單擊卡片可重新朗讀

### 5. 重新生成（可選）
**如需重新生成**：
- 單擊摘要卡片右上角的刷新圖標：播報「重新生成摘要」
- 雙擊刷新圖標：清除當前摘要並重新生成

## UI 元素說明

### AI 整理按鈕
```
┌─────────────────────────────────┐
│  ✨ AI 整理評論                 │
│  (紫色背景，白色文字)            │
└─────────────────────────────────┘
```
- 位置：評論標題下方
- 顏色：深紫色 (Colors.deepPurple)
- 圖標：✨ (auto_awesome)

### AI 摘要卡片
```
┌─────────────────────────────────┐
│ 🎨 AI 評論摘要          🔄      │
│ (紫色漸層背景)                   │
│─────────────────────────────────│
│ [AI 生成的摘要內容]             │
│ (約 100-150 字)                 │
│─────────────────────────────────│
│ ℹ️ 此摘要由 AI 自動生成，供參考使用│
└─────────────────────────────────┘
```
- 位置：所有評論的第一則
- 背景：紫色到粉紫色漸層
- 邊框：深紫色 2px
- 右上角：刷新按鈕

## 技術實現

### 檔案位置
[lib/pages/product/product_detail_page.dart](lib/pages/product/product_detail_page.dart)

### 關鍵方法

#### 1. `_initAiClient()` (第 50-70 行)
初始化 DeepSeek API 客戶端
```dart
void _initAiClient() {
  final apiKey = dotenv.env['DEEPSEEK_API_KEY'] ?? '';
  if (apiKey.isEmpty || apiKey == 'your_deepseek_api_key_here') {
    return; // API Key 未設置
  }

  final config = ProviderConfig(
    name: 'DeepSeek',
    baseUrl: 'https://api.deepseek.com',
    apiKey: apiKey,
    defaultModel: 'deepseek-chat',
  );

  _aiClient = OpenAICompatibleClient(config);
}
```

#### 2. `_generateAiReviewSummary()` (第 136-232 行)
生成 AI 評論摘要
- 過濾有文字內容的評論
- 檢查評論數量（需 >= 10）
- 構建提示詞
- 調用 DeepSeek API
- 播報生成的摘要

#### 3. `_buildAiSummaryCard()` (第 863-975 行)
構建 AI 摘要 UI 卡片
- 紫色漸層背景
- AI 圖標和標題
- 摘要內容顯示
- 重新生成按鈕
- 提示文字

### 狀態變數
```dart
String? _aiReviewSummary;           // AI 生成的評論摘要
bool _isGeneratingAiSummary = false; // 是否正在生成
OpenAICompatibleClient? _aiClient;   // API 客戶端
```

## API 提示詞設計

### System Prompt
```
你是一位專業的電商評論分析助手，擅長從大量評論中提取關鍵資訊。
```

### User Prompt 結構
```
你是一位專業的電商評論分析師。請分析以下商品評論，並提供一份簡潔的摘要（約100-150字），重點包括：

1. 商品的主要優點（客戶最滿意的地方）
2. 商品的主要缺點或需要改進的地方（如果有）
3. 整體評價趨勢

商品名稱：[商品名稱]
評論總數：[評論數量] 則

評論內容：
[所有評論的列表]

請用繁體中文回答，語氣親切專業，適合朗讀給視障使用者聽。
直接提供摘要內容，不需要額外的標題或前綴。
```

### API 參數
- **Model**: `deepseek-chat`
- **Temperature**: `0.7` (適度創造性)
- **Max Tokens**: `500` (足夠產生 100-150 字的中文摘要)

## 配置要求

### 1. 環境變數設置
在專案根目錄的 `.env` 檔案中設置：
```bash
DEEPSEEK_API_KEY=your_actual_api_key_here
```

### 2. 取得 API Key
1. 訪問 [DeepSeek Platform](https://platform.deepseek.com/api_keys)
2. 註冊/登入帳號
3. 創建新的 API Key
4. 複製 Key 到 `.env` 檔案

### 3. 依賴套件
確保 `pubspec.yaml` 包含：
```yaml
dependencies:
  flutter_dotenv: ^5.0.2  # 環境變數管理
  dio: ^5.0.0             # HTTP 客戶端
```

## 錯誤處理

### 1. API Key 未設置
**情況**：環境變數中沒有有效的 API Key
**行為**：
- AI 整理按鈕不會顯示
- `_aiClient` 保持為 `null`

### 2. 評論數量不足
**情況**：有文字的評論少於 10 則
**行為**：
- AI 整理按鈕不會顯示
- 點擊時播報「評論數量不足，無法生成 AI 摘要」

### 3. API 調用失敗
**情況**：網路錯誤、API 限制、配額用盡等
**行為**：
- 播報「生成 AI 摘要失敗，請稍後再試」
- 顯示錯誤提示 SnackBar
- 按鈕恢復可用狀態

## 使用者體驗優化

### 1. 視覺反饋
- ⏳ 生成中：按鈕顯示載入動畫
- ✅ 生成完成：摘要卡片淡入顯示
- 🎨 清晰識別：紫色配色與一般評論區分

### 2. 語音反饋
- 🔊 操作前：播報按鈕功能
- 🔊 進行中：播報「正在生成...」
- 🔊 完成後：自動朗讀摘要內容

### 3. 互動設計
- 單擊：朗讀當前元素
- 雙擊：執行操作（生成/重新生成）
- 手勢一致：與整個 App 的手勢保持一致

## 效能考量

### 1. API 調用優化
- **快取機制**：生成後的摘要會保存在狀態中
- **避免重複**：已生成摘要時不顯示生成按鈕
- **重新生成**：僅在用戶明確要求時才重新調用

### 2. 資料處理
- **評論過濾**：僅傳送有文字內容的評論給 AI
- **數量限制**：所有符合條件的評論都會被分析
- **字數控制**：AI 生成約 100-150 字的摘要

### 3. 使用者等待時間
- **預期時間**：3-10 秒（視評論數量而定）
- **視覺提示**：載入動畫
- **語音提示**：告知正在生成

## 未來優化方向

1. **摘要快取**：將生成的摘要存入資料庫，避免重複生成
2. **多語言支援**：支援其他語言的評論分析
3. **情感分析**：顯示正面/負面評論比例
4. **關鍵字提取**：標示高頻提及的特點
5. **圖表展示**：視覺化評分分布
6. **更多 AI 功能**：
   - 與我的需求比對
   - 類似商品比較
   - 問答助手

## 測試建議

### 測試案例 1：正常流程
1. 找一個有 10+ 評論的商品
2. 滾動到評論區
3. 確認顯示「AI 整理評論」按鈕
4. 雙擊按鈕
5. 等待生成
6. 確認摘要顯示並自動朗讀

### 測試案例 2：評論不足
1. 找一個評論少於 10 則的商品
2. 確認不顯示「AI 整理評論」按鈕

### 測試案例 3：重新生成
1. 生成摘要後
2. 單擊右上角刷新圖標（朗讀提示）
3. 雙擊刷新圖標
4. 確認重新生成新的摘要

### 測試案例 4：API Key 未設置
1. 移除或註解 `.env` 中的 API Key
2. 重啟 App
3. 確認不顯示「AI 整理評論」按鈕

## 相關文件
- [OpenAI Client 實現](lib/services/openai_client.dart)
- [DeepSeek API 文檔](https://api-docs.deepseek.com)
- [商品比較服務](lib/services/product_comparison_service.dart)
