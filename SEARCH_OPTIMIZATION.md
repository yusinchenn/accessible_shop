# 搜尋功能優化說明

## 優化內容

### 1. 新增模糊搜尋工具類
位置: `lib/utils/fuzzy_search_helper.dart`

提供以下功能：
- **編輯距離算法 (Levenshtein Distance)**：計算兩個字串的相似度
- **字符包含度計算**：檢查關鍵字中的字符在目標字串中出現的比例
- **連續字符匹配**：找出最長的連續匹配子字串
- **綜合模糊評分**：結合多種算法的綜合評分

### 2. 優化搜尋排序規則
位置: `lib/services/database_service.dart` - `searchProducts()` 方法

#### 排序優先級（分數由高到低）

| 優先級 | 匹配類型 | 分數範圍 | 說明 |
|--------|---------|---------|------|
| 1 | 商品名稱完全匹配 | 100 | 例如：搜尋"背包"，找到名為"背包"的商品 |
| 2 | 商品名稱開頭匹配 | 95 | 例如：搜尋"背"，找到"背包" |
| 3 | 商品名稱包含關鍵字 | 90 | 例如：搜尋"背包"，找到"時尚背包組" |
| 4 | 描述完全匹配 | 80 | 描述文字與關鍵字完全相同 |
| 5 | 描述包含關鍵字 | 70 | 描述中包含關鍵字 |
| 6 | 店家名稱完全匹配 | 60 | 例如：搜尋"Nike"，找到 Nike 店家的商品 |
| 7 | 店家名稱包含關鍵字 | 50 | 例如：搜尋"Nike"，找到"Nike Taiwan"店家的商品 |
| 8 | 分類包含關鍵字 | 40 | 例如：搜尋"3C"，找到分類為"3C產品"的商品 |
| 9 | 商品名稱模糊匹配 | 20-35 | 例如：搜尋"背包"，找到"提包"（相似但不完全匹配） |
| 10 | 描述模糊匹配 | 10-25 | 描述中有相似的字詞 |
| 11 | 店家名稱模糊匹配 | 5-15 | 店家名稱相似 |

### 3. 新增功能特色

#### 🎯 店家名稱搜尋
現在可以透過店家名稱搜尋商品：
- 搜尋 "Nike" 會找到所有 Nike 店家的商品
- 搜尋店家名稱的部分文字也能找到相關商品

#### 🔍 智能模糊匹配
使用多種演算法進行模糊匹配：
- **例子 1**：搜尋 "背包" 可以找到 "提包"、"包包"
- **例子 2**：搜尋 "手機" 可以找到 "智慧型手機"、"行動電話"
- **例子 3**：搜尋 "筆電" 可以找到 "筆記型電腦"、"電腦"

#### ⭐ 次要排序
當搜尋分數相同時，會按照商品評分（averageRating）排序，讓高評分商品優先顯示。

## 使用範例

### 基本使用
```dart
final db = Provider.of<DatabaseService>(context, listen: false);

// 精確搜尋
final results1 = await db.searchProducts('背包');

// 模糊搜尋
final results2 = await db.searchProducts('提包'); // 也會找到"背包"相關商品

// 店家搜尋
final results3 = await db.searchProducts('Nike'); // 找到所有 Nike 店家的商品
```

### 搜尋結果說明
搜尋結果會依照相關性排序：
1. 完全匹配的結果排在最前面
2. 部分匹配的結果在中間
3. 模糊匹配的結果在最後
4. 相同相關性的商品，評分高的優先顯示

## Debug 資訊
在 Debug 模式下，搜尋會輸出詳細的 log 資訊：
```
🔍 [DatabaseService] 資料庫總商品數: 50
🔍 [DatabaseService] 搜尋關鍵字: "背包"
🔍 [DatabaseService] 找到 12 筆符合的商品
🔍 [DatabaseService] 前 5 筆結果（含分數）:
   1. 背包 (分數: 100.0, 店家: 旅行者天堂)
   2. 時尚背包 (分數: 90.0, 店家: 時尚配件)
   3. 提包 (分數: 28.5, 店家: 皮革工坊)
   ...
```

## 技術細節

### 模糊匹配演算法

1. **Levenshtein Distance（編輯距離）**
   - 計算將一個字串轉換為另一個字串所需的最少編輯次數
   - 考慮插入、刪除、替換三種操作
   - 轉換為相似度分數：`1 - (distance / maxLength)`

2. **字符包含度**
   - 計算關鍵字中的字符在目標字串中出現的比例
   - 不考慮順序，只看字符是否存在

3. **連續字符匹配**
   - 找出關鍵字與目標字串之間最長的連續匹配子字串
   - 有助於識別部分相同的詞語

4. **綜合評分**
   - 結合以上三種算法，給予不同權重
   - 相似度 40%、字符包含度 30%、連續匹配 30%
   - 分數低於 20 分視為不相關

## 效能考量

- 店家資料使用 Map 快取，避免重複查詢
- 模糊匹配僅在精確匹配失敗時才執行
- 搜尋結果限制顯示數量，避免過長列表
- 相同分數的商品使用商品評分作為次要排序，減少隨機性

## 未來可能的優化方向

1. **搜尋歷史記錄**：記錄用戶搜尋歷史，提供自動完成建議
2. **熱門搜尋**：統計最常被搜尋的關鍵字
3. **同義詞支援**：建立同義詞字典（如：手機 = 行動電話）
4. **拼音搜尋**：支援拼音輸入搜尋中文商品
5. **分頁載入**：對於大量搜尋結果，實作分頁或無限滾動
